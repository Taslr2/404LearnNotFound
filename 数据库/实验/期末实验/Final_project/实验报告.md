# æ•°æ®åº“å®è·µå®éªŒæŠ¥å‘Š  
## å®éªŒå…­ï¼šåŸºäºå¤§æ¨¡å‹ä¸ MCP æœåŠ¡çš„è‡ªç„¶è¯­è¨€æ•°æ®åº“æŸ¥è¯¢ç³»ç»Ÿ

**å§“å**ï¼šé‚±å‰å°”  
**å­¦å·**ï¼š10235101533  
**å®Œæˆæ—¥æœŸ**ï¼š2025å¹´6æœˆ28æ—¥
**é¡¹ç›®åœ°å€**ï¼š[404LearnNotFound/æ•°æ®åº“/å®éªŒ/æœŸæœ«å®éªŒ/Final_project at main Â· Taslr2/404LearnNotFound](https://github.com/Taslr2/404LearnNotFound/tree/main/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%AE%9E%E9%AA%8C/%E6%9C%9F%E6%9C%AB%E5%AE%9E%E9%AA%8C/Final_project) 


---

### ç‰¹åˆ«æ³¨æ„

ï¼ˆä¸­é€”ä¿®æ”¹æ—¶æ“ä½œä¸å½“ï¼Œå¯¼è‡´æœ€åå‘ç°åˆ†é¡µåŠŸèƒ½å¤±æ•ˆäº†ï¼Œè¿˜é˜»å¡äº†ä¸»è¿›ç¨‹è¿è¡Œï¼Œæ—¶é—´ä¸å¤ªå……è£•æ¥ä¸åŠdebugï¼Œæœ›è°…è§£ï¼‰

å°†`proxy_api.py`ä¸­çš„39-55è¡Œæ³¨é‡Šï¼Œ56è¡Œå–æ¶ˆæ³¨é‡Šå³å¯æŸ¥çœ‹æœªåˆ†é¡µçš„æŸ¥è¯¢ç»“æœï¼Œå¦‚ä¸‹ï¼š

```python
            # content = result.content
            # if content and isinstance(content, list):
            #     first_text_content = content[0]
            #     json_str = first_text_content.text
            #     try:
            #         data = json.loads(json_str)
            #         if data.get("success"):
            #             last_results = data.get("results", [])
            #             page_index = 0
            #             show_page(last_results, page_index, PAGE_SIZE)
            #         else:
            #             print("âŒ æŸ¥è¯¢å¤±è´¥ï¼š", data.get("error"))
            #     except Exception as e:
            #         print("âŒ è§£æé”™è¯¯:", e)
            #         print("åŸå§‹æ–‡æœ¬ï¼š", json_str)
            # else:
            #     print("è¿”å›æ ¼å¼é”™è¯¯")
            	 parse_result(result)
```



### ä¸€ã€å®éªŒç›®çš„

ç»¼åˆè¿ç”¨æ•°æ®åº“çŸ¥è¯†ã€æœåŠ¡ç«¯å¼€å‘æŠ€èƒ½ä¸å¤§æ¨¡å‹è°ƒç”¨æŠ€æœ¯ï¼Œå®Œæˆä¸€ä¸ªåŸºäº MCP åè®®çš„æ•°æ®æŸ¥è¯¢ç³»ç»Ÿï¼Œå¹¶æ¢ç´¢å…¶åŠŸèƒ½æ‰©å±•ä¸ä¼˜åŒ–æ–¹å¼ã€‚

ç›®çš„åŒ…æ‹¬ï¼š
1. éƒ¨ç½²å¹¶ç†è§£ MCP æœåŠ¡ç»“æ„
2. ç¼–å†™ä¸LLM APIäº¤äº’æ¨¡å—ï¼Œå®ç°è‡ªç„¶è¯­è¨€â†’SQLç”Ÿæˆ
3. ä¸ MCP æœåŠ¡è”é€šï¼Œæ‰§è¡ŒæŸ¥è¯¢å¹¶è¿”å›ç»“æœ
4. å¢å¼º MCP åŠŸèƒ½ï¼ˆå¦‚æŸ¥è¯¢æ—¥å¿—ã€åˆ†é¡µã€ç™½åå•æ ¡éªŒï¼‰
5. å®ç° CLI æˆ– GUI æŸ¥è¯¢ç•Œé¢
6. æ¢ç´¢ Prompt ä¼˜åŒ–æ–¹æ³•ä»¥æå‡ SQL æ­£ç¡®ç‡æˆ–æ•ˆç‡

---

### äºŒã€å®éªŒè¿‡ç¨‹

#### 1. MCP æœåŠ¡è¿è¡Œ

##### (1) ä¸‹è½½å¹¶éƒ¨ç½² alexcc4/mcp-mysql-server

- ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å°†å¼€æºå·¥å…·éƒ¨ç½²åˆ°æœ¬åœ°
```bash
git clone https://github.com/alexcc4/mcp-mysql-server.git
```

- è¿›å…¥ mysql-mcp-server ç›®å½•ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å®‰è£…ä¾èµ–ï¼š

```bash
uv sync
```

- å…¶æ¬¡ï¼Œå¯åœ¨ README æ–‡ä»¶ä¸­æ‰¾åˆ° Claude Desktop é…ç½®æ–‡ä»¶çš„å†…å®¹ï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨çš„æ˜¯ cline_mcpï¼Œåœ¨ cline_mcp_setting.json ä¸­é…ç½®å¦‚ä¸‹ä»£ç ï¼š

```json
{
    "mcpServers": {
        "sql": {
            "command": "E:\\python\\CPython\\Scripts\\uv.exe",
            "args": [
                "--directory",
                "F:\\Desktop\\æ•°æ®åº“\\æœŸæœ«å®éªŒ\\mcp-mysql-server",
                "run",
                "main.py"
            ],
            "env": {
                "DB_HOST": "127.0.0.1",
                "DB_PORT": "3306",
                "DB_USER": "root",
                "DB_PASSWORD": "your_password",
                "DB_NAME": "college"
           }
        }
    }
}
```

- æ­¤æ—¶å‘ç° MCP Servers æŠ¥é”™ï¼š534 ListToolsRequest
  google åæ‰¾åˆ°å¦‚ä¸‹è§£å†³åŠæ³•ï¼š
  åœ¨ main.py ä¸­çš„ mcp = FastMCP(â€mysql-serverâ€) ä¸­æ·»åŠ å‚æ•°ï¼š
  mcp = FastMCP(â€mysql-serverâ€,log_level=â€ERRORâ€)ï¼Œä»¥æ­¤è·³è¿‡éå¿…è¦çš„å·¥å…·æ£€æŸ¥



- æ¥ç€åœ¨ cline è®¾ç½®ä¸­è®¾ç½® API Provider ä¸º OpenRouterï¼Œå¹¶åœ¨ OpenRouter å®˜ç½‘è·å–API Key, æœ€åé€‰æ‹©åç¼€å¸¦æœ‰ free çš„æ¨¡å‹å³å¯

##### (2)è¿æ¥ MySQL å®ä¾‹

å‰ç½®å·¥ä½œå®Œæˆï¼Œæ¥ç€å°±å¯å‘ cline æé—®ï¼Œå¦‚ä¸‹ï¼š

â€‹    <img src=".\images\1.png" width="50%" style="display: inline-block;">

å¯ä»¥çœ‹åˆ°å·²ç»æˆåŠŸè¾“å‡º college æ•°æ®åº“ä¸­çš„æ‰€æœ‰è¡¨



### äºŒã€å®éªŒè¿‡ç¨‹ï¼ˆé‡ç½®ç‰ˆï¼‰

#### 1ã€é¡¹ç›®æ¶æ„è®¾è®¡

å®éªŒè¿›è¡Œåˆ°ç¬¬äºŒæ­¥æ—¶å‘ç°éœ€è¦è‡ªå·±å®Œæˆæ¨¡å—è°ƒç”¨æ‰èƒ½å®Œæˆåç»­ç›®æ ‡ï¼Œä¸èƒ½å€ŸåŠ© cline æ’ä»¶ï¼Œå› æ­¤éœ€è¦é‡æ–°å®Œæˆä¸€æ¬¡ï¼Œé¦–å…ˆè®¾è®¡æ•´ä½“çš„é¡¹ç›®æ¶æ„ï¼š

```
Final_project/
â”œâ”€â”€ backend/                    # MCP æœåŠ¡ + LLMé›†æˆæ¨¡å—
â”‚   â”œâ”€â”€ main.py                 # MCPæœåŠ¡ä¸»å…¥å£ï¼Œå°† alexcc4/mcp-mysql-serverä¸­çš„main.pyæ‹·è¿‡æ¥å³å¯
â”‚   â”œâ”€â”€ .env                    # æ•°æ®åº“è¿æ¥ç¯å¢ƒå˜é‡
â”‚   â”œâ”€â”€ llm_interface.py        # ä¸é€šä¹‰åƒé—®äº¤äº’ï¼Œç”ŸæˆSQL
â”‚   â””â”€â”€ proxy_api.py            # å‰ç«¯ç»Ÿä¸€è°ƒç”¨çš„ä¸­é—´ä»£ç†å±‚                  
â”œâ”€â”€ frontend/                   # React + Tailwind å‰ç«¯
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ App.tsx             # é¡µé¢ä¸»å…¥å£
â”‚   â”‚   â”œâ”€â”€ api/index.ts        # è°ƒç”¨åç«¯API
â”‚   â”‚   â””â”€â”€ components/         # ç»„ä»¶
â”‚   â””â”€â”€ vite.config.ts          # CORSä»£ç†é…ç½®
â””â”€â”€ config/                     # æ•°æ®åº“é…ç½®æ¨¡å—
    â””â”€â”€ config.py
```

#### 2.MCPæœåŠ¡è¿è¡Œ

##### 2.1 .env é…ç½®

é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š

```
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=college
```



éœ€è¦ä»main.pyç›´æ¥è®¿é—®åˆ°åŒæ–‡ä»¶å¤¹ä¸‹çš„.envé…ç½®æ–‡ä»¶ï¼Œå› æ­¤éœ€è¦æ·»åŠ ä¸¤è¡Œä»£ç ï¼š

```python
from dotenv import load_dotenv

load_dotenv()  
```

 è®©ç¨‹åºè‡ªåŠ¨è¯»å–æ ¹ç›®å½•ä¸‹çš„ .env æ–‡ä»¶



##### 2.2 è¿æ¥åˆ°MYSQLç¤ºä¾‹

æ³¨æ„åˆ°åŸmain.pyæ–‡ä»¶ä¸­çš„mainå‡½æ•°ç›´æ¥æ‰§è¡Œäº†mcp.run()ï¼Œä¼šæ˜¯é˜»å¡è¿è¡Œ MCP æœåŠ¡çš„ï¼Œå¯åŠ¨åæ²¡æœ‰é¢å¤–çš„é»˜è®¤æ‰“å°ï¼Œå› æ­¤å…ˆè¿è¡Œmainï¼Œå…ˆæ‰“å°å¯åŠ¨ä¿¡æ¯ï¼š

```python
if __name__ == "__main__":
    main()      
    mcp.run()   
```

è¿è¡Œ ` uv run main.py` åï¼Œç»ˆç«¯è¾“å‡ºï¼š
<img src=".\images\2.png" width="80%" style="display: inline-block;">

å¯è§å·²ç»æˆåŠŸè¿æ¥åˆ°æ•°æ®åº“





#### 3.é€šä¹‰API è°ƒç”¨æ¨¡å—

##### 3.1 llm_interface.pyæ¨¡å—è¯¦è§£

```python
import os
import httpx
from dotenv import load_dotenv
```

- `os`ï¼šç”¨äºè¯»å–ç¯å¢ƒå˜é‡
- `httpx`ï¼šæ”¯æŒå¼‚æ­¥çš„ HTTP å®¢æˆ·ç«¯åº“
- `load_dotenv()`ï¼šä» `.env` æ–‡ä»¶åŠ è½½ API å¯†é’¥ç­‰ç¯å¢ƒé…ç½®



` load_dotenv()`  

- åŠ è½½ `.env` æ–‡ä»¶ä¸­å®šä¹‰çš„å˜é‡ï¼ˆå¦‚ `QWEN_API_KEY`ï¼‰åˆ° `os.environ` ä¸­ï¼Œä¾›åç»­ä½¿ç”¨



` QWEN_API_KEY = os.getenv("QWEN_API_KEY")`

- ä»ç¯å¢ƒå˜é‡ä¸­è¯»å–é€šä¹‰åƒé—®çš„ API key



` QWEN_URL = "https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation"`

- é€šä¹‰åƒé—®API æ¥å£åœ°å€ï¼Œè¯¥æ¥å£æ¥æ”¶ promptï¼Œè¿”å›æ¨¡å‹ç”Ÿæˆçš„æ–‡æœ¬



###### 3.1.1 prompt æ¨¡æ¿å®šä¹‰

``` python
PROMPT_TEMPLATE = """
ä½ æ˜¯ä¸€ä¸ªSQLç”ŸæˆåŠ©æ‰‹ã€‚è¯·æ ¹æ®ä¸‹é¢çš„è‡ªç„¶è¯­è¨€é—®é¢˜ç”Ÿæˆå¯¹åº”çš„MySQLæŸ¥è¯¢è¯­å¥ï¼Œåªè¿”å›SQLè¯­å¥ï¼Œä¸è¦æ·»åŠ è§£é‡Šè¯´æ˜ã€‚

æ•°æ®åº“ç»“æ„å¦‚ä¸‹ï¼š
{schema}

é—®é¢˜ï¼š
{question}
"""
```

- å‘é€ç»™å¤§è¯­è¨€æ¨¡å‹çš„æç¤ºè¯
- ä¼šè¢« `.format()` æ›¿æ¢ä¸ºå…·ä½“çš„ `schema`ï¼ˆæ•°æ®åº“ç»“æ„ï¼‰å’Œç”¨æˆ· `question`ã€‚
- æ˜ç¡®å‘Šè¯‰æ¨¡å‹ï¼š**åªç”Ÿæˆ SQLï¼Œä¸è¦æ³¨é‡Šæˆ–è¯´æ˜**ï¼Œå‡å°‘è¾“å‡ºå¼‚å¸¸å†…å®¹ã€‚



###### 3.1.2 æ ¸å¿ƒå‡½æ•°ï¼š`nl_to_sql`

```python
async def nl_to_sql(question: str, schema: str) -> str:
```

- å¼‚æ­¥å‡½æ•°ï¼Œå‚æ•°æ˜¯ï¼š
  - `question`ï¼šè‡ªç„¶è¯­è¨€é—®é¢˜ï¼ˆç”¨æˆ·è¾“å…¥ï¼‰
  - `schema`ï¼šæ•°æ®åº“ç»“æ„ï¼ˆå¦‚è¡¨åã€å­—æ®µï¼‰



``` python
prompt = PROMPT_TEMPLATE.format(question=question, schema=schema)
```

- æ ¹æ®è¾“å…¥ä¸æ•°æ®åº“ç»“æ„ç”Ÿæˆæœ€ç»ˆ promptï¼Œå‘é€ç»™é€šä¹‰åƒé—®



``` python
headers = {
      "Authorization": f"Bearer {QWEN_API_KEY}",
       "Content-Type": "application/json"
	}
```

- è®¾ç½®è¯·æ±‚å¤´ï¼š
  - `Authorization`ï¼šæºå¸¦ä¸ªäººçš„ API å¯†é’¥
  - `Content-Type`ï¼šå‘Šè¯‰æœåŠ¡ç«¯ä¼ çš„å†…å®¹æ˜¯ JSON



```python
    body = {
        "model": "qwen-turbo",
        "input": {
            "prompt": prompt
        },
        "parameters": {
            "result_format": "message"
        }
    }
```

- è¯·æ±‚ä½“ï¼š
  - `model`: ä½¿ç”¨çš„æ¨¡å‹ï¼Œå¦‚ `qwen-turbo`
  - `input.prompt`: ä¸Šé¢æ„é€ å¥½çš„æ–‡æœ¬æç¤º
  - `parameters.result_format`: æŒ‡å®šè¿”å›æ ¼å¼ä¸º `"message"`



```python
    async with httpx.AsyncClient(timeout=30.0) as client:
        response = await client.post(QWEN_URL, headers=headers, json=body)
        response.raise_for_status()
        result = response.json()
        return result["output"]["choices"][0]["message"]["content"].strip()

```

- å‘èµ·è¯·æ±‚å¹¶å¤„ç†å“åº”ï¼š
  - ç”¨ `httpx.AsyncClient` å¼‚æ­¥å‘é€ POST è¯·æ±‚
  - `raise_for_status()` å¦‚æœ HTTP ä¸æ˜¯ 200ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸
  - `.json()` è§£æå“åº”ä½“
  - `result["output"]["text"]` æå–è¿”å›çš„ SQL



##### 3.2 å®‰è£…ä¾èµ–

åœ¨` pyproject.toml`ä¸­æ·»åŠ ï¼š

```python
dependencies = [
    "httpx>=0.25.0",
    "python-dotenv>=1.0.0"
]
```

å†é€šè¿‡uvå®‰è£…



##### 3.3 APIé…ç½®

åœ¨.envä¸­æ·»åŠ API_Keyé…ç½®ï¼š

`QWEN_API_KEY=your_API_Key`



##### 3.4 æµ‹è¯•æ˜¯å¦èƒ½è¾“å‡ºSQL

ç¼–å†™test.pyæ–‡ä»¶ï¼š

```python
import asyncio
from llm_interface import nl_to_sql

async def main():
    schema = schema = """
    students(id INT, name VARCHAR(50), age INT)
    courses(id INT, title VARCHAR(100))
    """
    question = input("è¯·è¾“å…¥é—®é¢˜ï¼š")
    sql = await nl_to_sql(question, schema)           
    print("ç”Ÿæˆçš„SQLï¼š", sql)

if __name__ == "__main__":
    asyncio.run(main())

```

å…ˆå°†schemaå›ºå®šï¼Œä»¥æ­¤æµ‹è¯•` nl_to_sql`å‡½æ•°åŠŸèƒ½ï¼š

<img src=".\images\3.png" width="60%" style="display: inline-block;">

å¯ä»¥æˆåŠŸè¾“å‡ºå¯¹åº”SQL



#### 4. æŸ¥è¯¢æ§åˆ¶æ¨¡å— 

##### 4.1 æ¨¡å—ç¼–å†™

å°†æ­¤åŠŸèƒ½å†™å…¥ä¸Šè¿°æåˆ°çš„` proxy_api.py`ä¸­ï¼Œæ­¤æ–‡ä»¶ä½œç”¨ä¸ºè‡ªç„¶è¯­è¨€æŸ¥è¯¢ä¸­é—´å±‚ï¼š



###### 4.1.1ä¾èµ–å¼•å…¥

```python
import asyncio
import textwrap
from mcp import ClientSession, StdioServerParameters, types
from mcp.client.stdio import stdio_client
```

- `asyncio`ï¼šç”¨äºå¼‚æ­¥è°ƒç”¨ MCP æœåŠ¡
- `nl_to_sql`ï¼šè‡ªå·±å†™çš„è‡ªç„¶è¯­è¨€å¤„ç†å±‚ï¼Œ**å°†è‡ªç„¶è¯­è¨€è½¬æˆ SQL**
- `ClientSession`ï¼šMCP å®¢æˆ·ç«¯è¿æ¥ä¼šè¯ï¼Œç”¨äºè°ƒç”¨èµ„æºå’Œå·¥å…·
- `stdio_client`ï¼šé€šè¿‡ **stdio** å¯åŠ¨å¹¶è¿æ¥ MCP æœåŠ¡çš„æ–¹å¼ï¼ˆå› ä¸ºmain.pyä¸­çš„mcp.run()æœªæºå¸¦ä»»ä½•å‚æ•°ï¼Œé»˜è®¤ä»¥stdioæ¨¡å¼å¯åŠ¨ï¼‰
- `StdioServerParameters`ï¼šç”¨äºæŒ‡å®š MCP æœåŠ¡å¯åŠ¨æ–¹å¼



###### 4.1.2 MCPæœåŠ¡é…ç½®

```python
server_params = StdioServerParameters(
    command="python",
    args=["main.py"],  
    env=None,
)
```

- `command="python"`ï¼šä½¿ç”¨ Python æ¥è¿è¡Œ MCP æœåŠ¡
- `args=["main.py"]`ï¼šè¿è¡Œå†™å¥½çš„ MCP æœåŠ¡ä»£ç  `main.py`
- `env=None`ï¼šä¸é¢å¤–æŒ‡å®šç¯å¢ƒå˜é‡



###### 4.1.3 ä¸»å¤„ç†å‡½æ•°` process_question`

```python
async def process_question(question: str):
    try:
        async with stdio_client(server_params) as (read, write):
            async with ClientSession(read, write) as session:
                await session.initialize()
                text_resource = content[1][0]
                json_str = text_resource.text

                data = json.loads(json_str)
                print("æ•°æ®åº“ schemaï¼š")
                print(json.dumps(data, indent=2, ensure_ascii=False))
                print(">> è·å–æ•°æ®åº“ schema...")
                content, _ = await session.read_resource("mysql://schema")

                print(">> ä½¿ç”¨å¤§æ¨¡å‹ç”Ÿæˆ SQL...")
                sql = await nl_to_sql(question, content)

                print(">> æ‰§è¡Œ SQL æŸ¥è¯¢...")
                result = await session.call_tool("query_data", {"sql": sql})

                return sql, result
    except Exception as e:
        import traceback
        print("âŒ å†…éƒ¨å¼‚å¸¸:")
        traceback.print_exc()
        raise e  
```

- å¯åŠ¨å¹¶è¿æ¥MCPæœåŠ¡
  - ä½¿ç”¨æ ‡å‡†è¾“å…¥è¾“å‡ºæ–¹å¼ï¼ˆ`stdio`ï¼‰è¿è¡Œ MCPï¼Œå¹¶ä¸å…¶å»ºç«‹é€šä¿¡ä¼šè¯
- è¯»å–æ•°æ®åº“ç»“æ„
  - è°ƒç”¨ MCP ä¸­æ³¨å†Œçš„èµ„æº `mysql://schema`ï¼Œè·å–æ•°æ®åº“ç»“æ„ï¼Œç”¨äºåç»­ SQL ç”Ÿæˆ
- è°ƒç”¨å¤§æ¨¡å‹ç”ŸæˆSQL
  - å°†ç”¨æˆ·è¾“å…¥çš„é—®é¢˜+schemaå‘é€ç»™å¤§æ¨¡å‹ï¼Œè®©å®ƒè¿”å›ä¸€ä¸ªSQLè¯­å¥
- æ‰§è¡ŒSQLæŸ¥è¯¢
  - è°ƒç”¨ MCP ä¸­æ³¨å†Œçš„å·¥å…· `query_data`ï¼Œæ‰§è¡Œåˆšåˆšç”Ÿæˆçš„ SQLï¼Œè¿”å›æŸ¥è¯¢ç»“æœ
- é”™è¯¯å¤„ç†
  - å¦‚æœæ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºé”™ï¼Œä¼šæ‰“å°è¯¦ç»†å †æ ˆ
- æ§åˆ¶å°ä¸»å¾ªç¯
  - æä¾›ä¸€ä¸ªå‘½ä»¤è¡Œäº¤äº’æ¥å£ï¼Œè®©ç”¨æˆ·å¯ä»¥ä¸æ–­è¾“å…¥è‡ªç„¶è¯­è¨€é—®é¢˜ï¼Œåå°è½¬ SQL æŸ¥è¯¢æ•°æ®åº“



##### 4.2 æ¨¡å—æµ‹è¯•

å› main.pyä½¿ç”¨uvå¯åŠ¨ï¼Œå› æ­¤æµ‹è¯•æ–‡ä»¶ä¹Ÿéœ€ä½¿ç”¨` uv proxy_api.py`å¯åŠ¨ï¼Œä»¥ä¿è¯ç¯å¢ƒä¸€è‡´æ€§ï¼Œå¦åˆ™ä¼šå‡ºç°503æŠ¥é”™

- ä»¥ä¸‹ä¸ºæµ‹è¯•ç»“æœï¼š

<img src=".\images\4.png" width="70%" style="display: inline-block;">



å¯ä»¥çœ‹åˆ°ç»“æœæŠ¥é”™æ‰¾ä¸åˆ°` courses`è¡¨ï¼Œä½†è§‚å¯Ÿæ•°æ®åº“å¯ä»¥å‘ç°è¡¨åä¸º` course`ï¼ŒAIå‡ºç°å¹»è§‰ï¼Œè¯´æ˜è·å–åˆ°çš„æ•°æ®åº“ç»“æ„schemaå¹¶æ²¡æœ‰æˆåŠŸä¼ é€’ç»™å¤§æ¨¡å‹ï¼Œéœ€è¿›è¡Œdebug



##### 4.3 æ¨¡å—å®Œå–„

###### 4.3.1 é—®é¢˜å®šä½

ä¸€ç•ªæ£€æŸ¥åæ²¡æœ‰å‘ç°é—®é¢˜ï¼Œå°è¯•è®©å¤§æ¨¡å‹è¾“å‡ºæ•°æ®åº“ä¸­æ‰€æœ‰è¡¨åï¼š

<img src=".\images\5.png" width="70%" style="display: inline-block;">

###### 4.3.2 promptä¿®æ”¹

å‘ç°å¯ä»¥æˆåŠŸè¿”å›æ‰€æœ‰çš„è¡¨åï¼Œå› æ­¤ä¸Šè¿°å‡ºç°` courses`çš„æƒ…å†µæ˜¯æ¨¡å‹æœ¬èº«çš„èƒ½åŠ›å¤„ç†é—®é¢˜ï¼Œå› æ­¤æˆ‘ä»¬å¢å¼ºpromptæ¨¡æ¿ï¼š

```json
PROMPT_TEMPLATE = """
ä½ æ˜¯ä¸€ä¸ªSQLç”ŸæˆåŠ©æ‰‹ã€‚è¯·æ ¹æ®ä¸‹é¢çš„è‡ªç„¶è¯­è¨€é—®é¢˜ç”Ÿæˆå¯¹åº”çš„MySQLæŸ¥è¯¢è¯­å¥ï¼Œåªè¿”å›SQLè¯­å¥ï¼Œä¸è¦æ·»åŠ è§£é‡Šè¯´æ˜ã€‚
ä½ è¦æ³¨æ„ç”Ÿæˆçš„SQLä¸­éœ€è¦çš„è¡¨ä¸€å®šè¦å‡ºç°åœ¨æ‰€è¿æ¥çš„æ•°æ®åº“å†…

æ•°æ®åº“ç»“æ„å¦‚ä¸‹ï¼š
{schema}

é—®é¢˜ï¼š
{question}
"""
```

 

###### 4.3.3 æ ¼å¼ç¾åŒ–

- åŒæ—¶å‘ç°è¾“å‡ºçš„schemaæ²¡æœ‰æˆåŠŸè¯†åˆ«\næ¢è¡Œï¼Œéœ€è¦ç¾åŒ–ï¼š
  - é€šè¿‡è°ƒè¯•å¯ä»¥è§‚å¯Ÿåˆ°ï¼š
    - `content` æ˜¯é•¿åº¦ä¸º 2 çš„å…ƒç»„
    - `content[0]` æ˜¯å­—ç¬¦ä¸² `"contents"` ï¼ˆä¸æ˜¯ JSONï¼‰
    - `content[1]` æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œé‡Œé¢åŒ…å«ä¸€ä¸ª `TextResourceContents` å¯¹è±¡
    - è¿™ä¸ªå¯¹è±¡çš„ `text` å±æ€§æ‰æ˜¯éœ€è¦çš„ JSON å­—ç¬¦ä¸²
  - è§£å†³æ–¹æ¡ˆï¼š
    - ä» `content[1]` è¿™ä¸ªåˆ—è¡¨ä¸­å–ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå†è®¿é—®å®ƒçš„ `.text` å±æ€§ï¼Œæ‰æ˜¯ JSON æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œç„¶åå†ç”¨ `json.loads()` è§£æ

åœ¨` process_question`ä¸­æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š

```python
 text_resource = content[1][0]
 json_str = text_resource.text

 data = json.loads(json_str)
 print("æ•°æ®åº“ schemaï¼š")
 print(json.dumps(data, indent=2, ensure_ascii=False))
```



- åŒç†å‘ç°è¾“å‡ºçš„resultä¹Ÿéœ€è¦ç¾åŒ–

  - è¾“å‡ºtypeï¼ˆresultï¼‰ç»“æœä¸ºï¼š <class 'mcp.types.CallToolResult'>

  - å› æ­¤éœ€è¦ä¸€ä¸ªæ–°å‡½æ•°å°†CallToolResult å¯¹è±¡è½¬ä¸ºPythonå¯¹è±¡

  - å…·ä½“å®ç°å¦‚ä¸‹ï¼š

  - ```python
    def parse_result(result):
        content = result.content  
        if content and isinstance(content, list):
            first_text_content = content[0]
            json_str = first_text_content.text  # å–å‡ºjsonå­—ç¬¦ä¸²
            try:
                data = json.loads(json_str)
                #  json.loads æŠŠdataå­—å…¸è½¬æˆ Python å¯¹è±¡
                print("æŸ¥è¯¢æˆåŠŸï¼Ÿ", data.get("success"))
                print("æ€»è¡Œæ•°ï¼š", data.get("rowCount"))
                print("ç»“æœåˆ—è¡¨ç¤ºä¾‹ï¼š")
                for item in data.get("results", [])[:10]:  # åªæ‰“å°å‰10æ¡ï¼Œæ–¹ä¾¿è§‚å¯Ÿ
                    print(item)
            except Exception as e:
                print("JSON è§£æé”™è¯¯:", e)
                print("åŸå§‹æ–‡æœ¬ï¼š", json_str)
        else:
            print("è¿”å›ç»“æœæ ¼å¼ä¸ç¬¦åˆé¢„æœŸ:", content)
    ```

    â€‹

###### 4.3.2 æµ‹è¯•æŸ¥è¯¢

ä¿®æ”¹è¿‡åå†æ¬¡å°è¯•æ‰§è¡ŒæŸ¥è¯¢ï¼š` List the names of all courses ordered by their titles and credits`

<img src=".\images\6.png" width="70%" style="display: inline-block;">

å¯ä»¥çœ‹åˆ°æˆåŠŸä»¥jsonæ ¼å¼è¿”å›äº†å‰10æ¡æŸ¥è¯¢ç»“æœ

å¹¶ä¸”å¯ä»¥åœ¨ç»ˆç«¯è¿›è¡Œäº¤äº’ï¼Œè‡³æ­¤ï¼Œå·²å®Œæˆå…¨éƒ¨çš„åŸºç¡€ä»»åŠ¡



#### 5.æŸ¥è¯¢æ—¥å¿—è®°å½•/logs

##### 5.1 åœ¨main.pyä¸­è®°å½•æ—¥å¿—

###### 5.1.1 å®šä¹‰å…¨å±€æ—¥å¿—è®°å½•

åŠ å…¥ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œç”¨äºå­˜å‚¨æŸ¥è¯¢æ—¥å¿—ï¼š

```python
from datetime import datetime

query_logs = []  # å…¨å±€åˆ—è¡¨ï¼Œå­˜å‚¨æ¯æ¬¡æŸ¥è¯¢è®°å½•
```



###### 5.1.2 åœ¨ `query_data` ä¸­è®°å½•æ—¥å¿—

ä¿®æ”¹ `query_data` å‡½æ•°ï¼Œåœ¨æˆåŠŸæ‰§è¡ŒæŸ¥è¯¢åè¿½åŠ ä¸€æ¡æ—¥å¿—è®°å½•ï¼š

```python
query_logs.append({
    "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
    "sql": sql
})
```



###### 5.1.3 æš´éœ² /logs èµ„æºæ¥å£

æ·»åŠ ä¸€ä¸ª MCP èµ„æºï¼Œç”¨äºè¯»å–æ—¥å¿—ï¼š

```python
@mcp.resource("mysql://logs")
def get_query_logs() -> Dict[str, Any]:
    return {
        "count": len(query_logs),
        "logs": query_logs
    }
```



###### 5.1.4 ç”¨æˆ·ç«¯è¾“å‡ºæ—¥å¿—

åœ¨proxy_api.pyæ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹ä»£ç ï¼Œç”¨æˆ·åœ¨è¾“å…¥logsæ—¶å³å¯è¾“å‡ºæ›¾æ‰§è¡Œçš„sqlæŸ¥è¯¢ï¼š

```python
if question.lower() == "logs":
   print(">> è·å–æŸ¥è¯¢æ—¥å¿—...")
   async def fetch_logs():
         try:
           async with stdio_client(server_params) as (read, write):
              async with ClientSession(read, write) as session:
                    await session.initialize()
                    meta, content = await session.read_resource("mysql://logs")
                    text_resource = content[1][0]
                    logs = json.loads(text_resource.text)
                    print("æ—¥å¿—å†…å®¹å¦‚ä¸‹ï¼š")
                    print(json.dumps(logs, indent=2, ensure_ascii=False))
         except Exception as e:
            print("è·å–æ—¥å¿—å¤±è´¥ï¼š", e)
```



###### 5.1.5 æŒä¹…åŒ–å­˜å‚¨æ—¥å¿—è®°å½•

ä»¥ä¸Šæ“ä½œåç†åº”å¯ä»¥æˆåŠŸè¾“å‡ºæ—¥å¿—è®°å½•ï¼Œä½†æ˜¯åœ¨æµ‹è¯•åå´å‘ç°å³ä¾¿æ‰§è¡Œäº†æŸ¥è¯¢ï¼Œè¾“å‡ºçš„æ—¥å¿—ä¹Ÿä¾ç„¶æ˜¯ç©ºçš„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
<img src=".\images\7.png" width="70%" style="display: inline-block;">

ä¸€ç•ªæ’æŸ¥åå‘ç°å› ä¸ºé…ç½®äº†ï¼š

```python
server_params = StdioServerParameters(
    command="python",
    args=["main.py"],  
    env=None,
)
```

å¯¼è‡´proxy_api.pyæ¯æ¬¡æé—®éƒ½ä¼šå¯åŠ¨ä¸€ä¸ªmain.pyå­è¿›ç¨‹ï¼Œå› æ­¤` query_logs`ä¼šè¢«æ¸…é›¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŒä¹…åŒ–å­˜å‚¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š

1. åœ¨ `query_data` ä¸­å°†æ—¥å¿—å†™å…¥ `logs.json`ï¼š

```python
import json

LOG_FILE = "logs.json"

def save_log(entry):
    try:
        logs = []
        if os.path.exists(LOG_FILE):
            with open(LOG_FILE, "r", encoding="utf-8") as f:
                logs = json.load(f)
        logs.append(entry)
        with open(LOG_FILE, "w", encoding="utf-8") as f:
            json.dump(logs, f, ensure_ascii=False, indent=2)
    except Exception as e:
        logger.error(f"Failed to save log: {e}")
```



2. ä¿®æ”¹ `query_data`ï¼š

   åœ¨` query_logs.append`åè°ƒç”¨`save_log`å‡½æ•°ï¼š

```python
save_log(query_logs[-1]) 
```



3. ä¿®æ”¹ `get_logs()` ä»æ–‡ä»¶ä¸­è¯»å–æ—¥å¿—ï¼š

```python
@mcp.resource("mysql://logs")
def get_logs():
    try:
        if os.path.exists(LOG_FILE):
            with open(LOG_FILE, "r", encoding="utf-8") as f:
                logs = json.load(f)
        else:
            logs = []
    except Exception as e:
        logger.error(f"Failed to read log file: {e}")
        logs = []
    
    return {
        "count": len(logs),
        "logs": logs[-100:]
    }
```



ä¿®æ”¹å®Œæˆåå°±åº”è¯¥å¯ä»¥è¾“å‡ºæ­£ç¡®çš„æ—¥å¿—è®°å½•äº†ï¼Œä»¥ä¸‹ä¸ºæµ‹è¯•æˆªå±ï¼š

<img src=".\images\8.png" width="60%" style="display: inline-block;">



#### 6.æŸ¥è¯¢ç»“æœåˆ†é¡µ

ä¸éœ€è¦æ”¹åŠ¨`main.py`ï¼Œç°åœ¨åªè¾“å‡º10æ¡æŸ¥è¯¢ç»“æœæ˜¯å› ä¸ºåœ¨`proxy_api.py`ä¸­æ·»åŠ äº†é™åˆ¶ï¼Œé˜²æ­¢æ˜¾ç¤ºè¿‡å¤šæ•°æ®ï¼Œå› æ­¤åªéœ€è¦ä¿®æ”¹æ­¤æ–‡ä»¶çš„é€»è¾‘å³å¯

##### 6.1 åœ¨ `main()` å‡½æ•°é¡¶éƒ¨æ·»åŠ ç¼“å­˜å˜é‡

```python
last_results = []
page_index = 0
PAGE_SIZE = 10
```



##### 6.2 æ·»åŠ ä¸€ä¸ªå‡½æ•°æ˜¾ç¤ºåˆ†é¡µå†…å®¹

```python
def show_page(results, page, page_size=10):
    total = len(results)
    start = page * page_size
    end = min(start + page_size, total)
    print(f"ğŸ“„ æ˜¾ç¤ºç¬¬ {start + 1} - {end} æ¡ï¼Œå…± {total} æ¡")
    for item in results[start:end]:
        print(item)
    if end < total:
        print("ğŸ‘‰ è¾“å…¥ 'next' æŸ¥çœ‹æ›´å¤š")
```



##### 6.3 åœ¨ `main()` å¾ªç¯ä¸­æ·»åŠ å¯¹ `next` çš„åˆ¤æ–­

åœ¨` main`ä¸­æ·»åŠ ä¸‹åˆ—å†…å®¹ï¼š

```python
if question.lower() == "next":
    if last_results:
        page_index += 1
        show_page(last_results, page_index, PAGE_SIZE)
    else:
        print("âš ï¸ æš‚æ— ä¸Šæ¬¡æŸ¥è¯¢ç»“æœ")
    continue
```



##### 6.4 å¤„ç†å®Œä¸€æ¬¡æŸ¥è¯¢åä¿å­˜ç»“æœå¹¶æ˜¾ç¤ºç¬¬ä¸€é¡µ

å°†åŸæœ¬çš„ç»“æœæ˜¾ç¤ºéƒ¨åˆ†`parse_result(result)`æ›¿æ¢ä¸ºï¼š

```python
content = result.content
if content and isinstance(content, list):
    first_text_content = content[0]
    json_str = first_text_content.text
    try:
        data = json.loads(json_str)
        if data.get("success"):
            last_results = data.get("results", [])
            page_index = 0
            show_page(last_results, page_index, PAGE_SIZE)
        else:
            print("âŒ æŸ¥è¯¢å¤±è´¥ï¼š", data.get("error"))
    except Exception as e:
        print("âŒ è§£æé”™è¯¯:", e)
        print("åŸå§‹æ–‡æœ¬ï¼š", json_str)
else:
    print("è¿”å›æ ¼å¼é”™è¯¯")
```



##### 6.5 åˆ†é¡µç»“æœæµ‹è¯•

å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°å·²æˆåŠŸåˆ†é¡µï¼š

<img src=".\images\9.png" width="60%" style="display: inline-block;">



#### 7. è¡¨ç»“æ„ç®€åŒ–è¾“å‡º



#### 8.åªè¯»SQLç™½åå•è¿‡æ»¤

##### 8.1 æ›¿æ¢`query_data` ä¸­è°ƒç”¨çš„åˆ¤æ–­å‡½æ•°

```python
def is_select_query(sql: str) -> bool:
    sql_strip = sql.strip().lower()

    # å¿…é¡»ä»¥ select å¼€å¤´
    if not sql_strip.startswith("select"):
        return False

    # ä¸å…è®¸å¤šæ¡è¯­å¥ï¼ˆè¿™é‡Œç®€å•åˆ¤æ–­æ˜¯å¦æœ‰åˆ†å·ä¸”éæœ«å°¾ï¼‰
    if ';' in sql_strip[:-1]:
        return False

    return True
```

ä»¥æ­¤åªå…è®¸ä»¥selectå¼€å¤´çš„æŸ¥è¯¢

<img src=".\images\10.png" width="60%" style="display: inline-block;">



å¯ä»¥çœ‹åˆ°å·²ç»ä¸å…è®¸show tablesçš„æ“ä½œäº†



#### 9. å…³é”®å­—æ®µè®¿é—®æ§åˆ¶

##### 9.1 è®¾ç½®è¿ç¦è¯

é¦–å…ˆè®¾ç½®ä¸å…è®¸æŸ¥è¯¢çš„å­—æ®µ

```python
FORBIDDEN_FIELDS = ["password", "salary"]
```



å†ç¼–å†™ä¸€ä¸ªå‡½æ•°ï¼Œåˆ¤æ–­sqlæ˜¯å¦åŒ…å«äº†è¿™äº›è¯ï¼š

```python
def has_forbidden_fields(sql: str) -> bool:
    sql_lower = sql.lower()
    for field in FORBIDDEN_FIELDS:
        if field in sql_lower:
            return True
    return False
```



å¹¶åœ¨`query_data`å‡½æ•°ä¸­è°ƒç”¨ï¼š

```python
    if has_forbidden_fields(sql):
        return {
            "success": False,
            "error": "Query contains forbidden fields like password or salary."
        }
```

<img src=".\images\11.png" width="60%" style="display: inline-block;">



å‘ç°å¯¹äºè–ªæ°´çš„æŸ¥è¯¢è¢«é˜»æ­¢äº†



#### 10.ç®€æ˜“ SQL æ³¨å…¥é˜²å¾¡æœºåˆ¶ 

##### 10.1 ç¡®è®¤å¸¸è§çš„sqlæ³¨å…¥æ‰‹æ®µ

ç»´æŠ¤ä¸€ä¸ªâ€œæ³¨å…¥æ•æ„Ÿå…³é”®è¯åˆ—è¡¨â€ï¼Œå¦‚æœ SQL ä¸­å‡ºç°äº†è¿™äº›å…³é”®è¯ï¼ˆå°¤å…¶æ˜¯åœ¨å­—ç¬¦ä¸²æ‹¼æ¥çš„ä½ç½®ï¼‰ï¼Œåˆ™æ‹’ç»æ‰§è¡Œã€‚

æ¯”å¦‚æ£€æµ‹å¸¸è§çš„æ³¨å…¥å…³é”®è¯ï¼š

- `' or '1'='1'`
- `--`ï¼ˆSQLæ³¨é‡Šï¼‰
- `;` å¤šè¯­å¥åˆ†éš”
- `union select`
- `sleep(`ã€`benchmark(`ï¼ˆæ—¶é—´ç›²æ³¨ï¼‰
- `drop`ã€`insert` ç­‰å±é™©å‘½ä»¤ï¼ˆä½ å·²æœ‰ï¼‰



##### 10.2 æ£€æµ‹å­—ä¸²é˜²æ­¢æ³¨å…¥

åˆ›å»ºæ•°ç»„æŸ¥çœ‹è¾“å…¥æ˜¯å¦åŒ…å«è¿™äº›å…³é”®è¯

```python
INJECTION_PATTERNS = [
    "--",       # SQLæ³¨é‡Š
    "union ",   # è”åˆæŸ¥è¯¢æ³¨å…¥
    " or ",    # å¸¸è§æ¡ä»¶ç»•è¿‡
    "' or '1'='1",  # ç»å…¸æ³¨å…¥è¯­å¥
    "sleep(",  # æ—¶é—´ç›²æ³¨
    "benchmark(",
    "drop ",
    "insert ",
    "update ",
    "delete ",
    "exec ",
    "execute "
]

def contains_sql_injection(sql: str) -> bool:
    sql_lower = sql.lower()
    for pattern in INJECTION_PATTERNS:
        if pattern in sql_lower:
            return True
    return False

```

å¹¶é›†æˆåˆ°`query_data`å‡½æ•°ä¸­

<img src=".\images\12.png" width="60%" style="display: inline-block;">

å‘ç°æ°¸çœŸå¼çš„æŸ¥è¯¢è¢«æ‹’ç»



#### 11. å¤§æ¨¡å‹ä¼˜åŒ–ä»»åŠ¡

##### 11.1 æœªä¼˜åŒ–å‰æŸ¥è¯¢ç»“æœå±•ç¤ºï¼š

###### 11.1.1 Question10ï¼š

<img src=".\images\13.png" width="60%" style="display: inline-block;">

###### 11.1.2 Question16ï¼š

<img src=".\images\14.png" width="60%" style="display: inline-block;">



###### 11.1.3 Question 23ï¼š

<img src=".\images\15.png" width="60%" style="display: inline-block;">



###### 11.1.4 Question 33ï¼š

<img src=".\images\16.png" width="60%" style="display: inline-block;">



å¯¹ç…§è¿‡åå‘ç°åªæœ‰Question23çš„æŸ¥è¯¢æœ‰é—®é¢˜ï¼ˆå…ˆå‰å› ä¸ºæŸ¥è¯¢åˆ°äº†ä¸å­˜åœ¨çš„è¡¨ï¼Œå› æ­¤å·²ç»å¼ºåŒ–è¿‡æ¨¡æ¿ï¼Œå¯è§äº[4.3.2]()ï¼‰ï¼Œæ­¤æ—¶çš„æ¨¡æ¿ä¸ºï¼š

<img src=".\images\17.png" width="60%" style="display: inline-block;">



##### 11.2æ¨¡æ¿ä¼˜åŒ–

###### 11.2.1 é—®é¢˜åˆ†æ

Question23 æ˜¯ä¸€ä¸ªèšåˆ+ç­›é€‰**çš„é—®é¢˜ï¼Œè¦**æ‰¾å‡ºæœ‰å¤šä¸ªå¯¼å¸ˆçš„å­¦ç”Ÿ**ï¼Œå¸¸è§çš„ SQL å†™æ³•æ˜¯é€šè¿‡ `GROUP BY` + `HAVING COUNT(*) > 1`

è€Œç°åœ¨çš„æ¨¡æ¿**æ²¡æœ‰å¼•å¯¼å¤§æ¨¡å‹è¿›è¡Œâ€œå¤æ‚é€»è¾‘æ¨ç†â€**ï¼Œç‰¹åˆ«æ˜¯æ²¡æœ‰å¼ºè°ƒï¼š

- å…è®¸ä½¿ç”¨ `JOIN`ã€`GROUP BY`ã€`HAVING` ç­‰é«˜çº§ SQL è¯­æ³•ï¼›
- è¦å¯¹â€œä¸€ä¸ªå­¦ç”Ÿå¤šä¸ªå¯¼å¸ˆâ€è¿™ç§é€»è¾‘è¿›è¡Œ**æ¨æ–­**å’Œ**è½¬æ¢**ã€‚

å› æ­¤éœ€è¦åŠ å¼ºå¼•å¯¼



###### 11.2.2 æ¨¡æ¿æ”¹å–„

å°†æ¨¡æ¿æ”¹å–„ä¸ºï¼ˆç»“åˆçœŸå®å­—æ®µï¼‰ï¼š



```json
PROMPT_TEMPLATE = """
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ SQL æŸ¥è¯¢åŠ©æ‰‹ï¼Œæ“…é•¿å°†è‡ªç„¶è¯­è¨€é—®é¢˜å‡†ç¡®è½¬æ¢ä¸º MySQL æŸ¥è¯¢è¯­å¥ã€‚

è¯·æ ¹æ®æä¾›çš„æ•°æ®åº“ç»“æ„å’Œè‡ªç„¶è¯­è¨€é—®é¢˜ç”Ÿæˆä¸€ä¸ª **å‡†ç¡®ä¸”å®Œæ•´çš„ MySQL SELECT è¯­å¥**ã€‚æ³¨æ„ä»¥ä¸‹è§„åˆ™ï¼š

1. åªä½¿ç”¨æ•°æ®åº“ç»“æ„ä¸­åˆ—å‡ºçš„è¡¨å’Œå­—æ®µï¼Œä¸èƒ½çŒœæµ‹å­—æ®µåã€‚
2. æ”¯æŒä½¿ç”¨ JOINã€GROUP BYã€HAVING ç­‰è¯­æ³•ã€‚
3. å­—æ®µååŒºåˆ†å¤§å°å†™ï¼Œè¯·ä¸ç»“æ„å®Œå…¨ä¸€è‡´ï¼ˆå¦‚ s_ID è€Œä¸æ˜¯ student_idï¼‰ã€‚
4. ä»…è¿”å›æœ€ç»ˆçš„ SQL è¯­å¥ï¼Œä¸åŒ…å«æ³¨é‡Šæˆ–é¢å¤–è¯´æ˜ã€‚

æ•°æ®åº“ç»“æ„å¦‚ä¸‹ï¼š
{schema}

è‡ªç„¶è¯­è¨€é—®é¢˜ï¼š
{question}
"""
```



#####  11.3 å¤šè½®æç¤ºç»“æ„/ ç¤ºä¾‹å¢å¼º

åœ¨å·²æœ‰çš„æ¨¡æ¿ä¸­åµŒå…¥å¤šè½®æç¤ºï¼š

```json
PROMPT_TEMPLATE = """
ä½ æ˜¯ä¸€ä¸ªç»éªŒä¸°å¯Œçš„SQLç”ŸæˆåŠ©æ‰‹ï¼Œæ“…é•¿å°†è‡ªç„¶è¯­è¨€è½¬æ¢ä¸ºæ­£ç¡®çš„MySQLæŸ¥è¯¢è¯­å¥ã€‚è¯·æ ¹æ®ä¸‹é¢çš„è‡ªç„¶è¯­è¨€é—®é¢˜ç”Ÿæˆå¯¹åº”çš„MySQLæŸ¥è¯¢è¯­å¥ï¼Œ**åªè¿”å›æœ€ç»ˆçš„ SQL ä»£ç ï¼Œä¸éœ€è¦è§£é‡Šè¯´æ˜**ã€‚

ä½ éœ€è¦ç‰¹åˆ«æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š
1. æ”¯æŒä½¿ç”¨ JOINã€GROUP BYã€HAVING ç­‰ SQL é«˜çº§è¯­æ³•ã€‚
2. ç»“åˆæ•°æ®åº“ç»“æ„ï¼Œå‡†ç¡®ç†è§£é—®é¢˜ä¸­çš„é€»è¾‘ï¼Œä¾‹å¦‚â€œå¤šä¸ªâ€â€œè‡³å°‘ä¸€ä¸ªâ€â€œæ²¡æœ‰â€ç­‰ã€‚
3. SQLä¸­ä½¿ç”¨çš„è¡¨å’Œå­—æ®µå¿…é¡»æ¥è‡ªä»¥ä¸‹æ•°æ®åº“ç»“æ„ã€‚
4. è¿”å›çš„è¯­å¥å¿…é¡»æ˜¯æ ‡å‡† MySQL SELECT è¯­å¥ï¼Œä¸åŒ…å« INSERTã€UPDATE ç­‰æ“ä½œã€‚

ä»¥ä¸‹æ˜¯ä¸€äº›ç¤ºä¾‹ä¾›ä½ å‚è€ƒï¼š

ã€ç¤ºä¾‹1ã€‘
æ•°æ®åº“ç»“æ„ï¼š
student(s_ID, name)
advisor(s_ID, i_ID)

è‡ªç„¶è¯­è¨€é—®é¢˜ï¼š
Which students have more than one advisor?

SQLï¼š
SELECT student.name
FROM student
JOIN advisor ON student.s_ID = advisor.s_ID
GROUP BY student.s_ID
HAVING COUNT(DISTINCT advisor.i_ID) > 1;

---

ã€ç¤ºä¾‹2ã€‘
æ•°æ®åº“ç»“æ„ï¼š
course(course_id, title, credits)

è‡ªç„¶è¯­è¨€é—®é¢˜ï¼š
List all courses that are worth more than 3 credits.

SQLï¼š
SELECT title FROM course WHERE credits > 3;

---

ã€ç¤ºä¾‹3ã€‘
æ•°æ®åº“ç»“æ„ï¼š
instructor(i_ID, name, salary, dept_name)

è‡ªç„¶è¯­è¨€é—®é¢˜ï¼š
Find the names of instructors who earn more than 100000.

SQLï¼š
SELECT name FROM instructor WHERE salary > 100000;

---

ç°åœ¨ï¼Œè¯·æ ¹æ®ä¸‹é¢æä¾›çš„æ•°æ®åº“ç»“æ„å’Œè‡ªç„¶è¯­è¨€é—®é¢˜ç”Ÿæˆ SQL æŸ¥è¯¢ï¼š

æ•°æ®åº“ç»“æ„å¦‚ä¸‹ï¼š
{schema}

è‡ªç„¶è¯­è¨€é—®é¢˜ï¼š
{question}
"""

```



##### 11.4 SQL æ‰§è¡Œè®¡åˆ’ç®€åŒ–å»ºè®®

åœ¨ä¸Šè¿°æ¨¡æ¿ä¸­æ–°å¢ç¬¬äº”ç‚¹å³å¯ï¼š

```python
5. è¯·ä¼˜åŒ–è¯­å¥ç»“æ„ï¼Œå°½é‡é¿å…ä½æ•ˆçš„åµŒå¥—å­æŸ¥è¯¢ã€å†—ä½™çš„ IN å­å¥ï¼Œä¼˜å…ˆä½¿ç”¨ JOIN ç­‰é«˜æ•ˆæ–¹å¼æå‡æŸ¥è¯¢æ€§èƒ½ã€‚
```



ä¼˜åŒ–è¿‡åå³å¯æˆåŠŸå®ŒæˆQuestion23çš„æŸ¥è¯¢

#### 14.GUI ç•Œé¢ï¼ˆå¦‚ Streamlitï¼‰ 

åˆšå¼€å§‹æœ‰ç”¨reactæ­å»ºå‰ç«¯çš„è®¾æƒ³ï¼Œè¿«äºå·¥ä½œé‡æœ€åé€‰æ‹©ç¾åŒ–ä¸€ä¸‹CLIï¼ˆï¼‰
ä½¿ç”¨`rich `åŒ…çš„Consoleç¾åŒ–è¾“å‡ºï¼Œä½¿å…¶è‡ªå¸¦é¢œè‰²å³å¯ï¼Œæ·»åŠ å³å¯ï¼š

```python
from rich import print 
from rich.table import Table
from rich.console import Console

console = Console()
```

æ­¤æ—¶çš„æ•°æ®å³ä¼šå˜ä¸ºï¼š

<img src=".\images\16.png" width="60%" style="display: inline-block;">

 

ç»¼ä¸Šå³ä¸ºæœ¬æ¬¡å®éªŒ

 







